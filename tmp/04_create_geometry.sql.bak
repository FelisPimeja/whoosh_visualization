drop table if exists routes; 
create table routes as 
--
select trip_id, started_at, finished_at,
	st_setsrid(
	    st_makeline(
	        st_point(
	            (latlon ->> 'lng')::float,
	            (latlon ->> 'lat')::float
	        )
	        order by idx
	    ),
	    4326
	) geom
from (
    select r.*, idx, latlon
    from routes_raw r, json_array_elements(path::json -> 'coordinates') with ordinality as coord(latlon, idx)
    where latlon::text !~* '\y0\.0\y' -- отфильтровываем 0.0 координаты как заведомый мусор
) coords
group by trip_id, started_at, finished_at;

create index on routes using gist(geom);
